+++
weight = 40215
title = 'SI7021, HTU21, SHT21 Humidity & Temperature I2C'
+++

![](/images/docs/demo/si7021.jpg)

SI7021, HTU21 and SHT21 are nearly identical I2C temperature (-10 to 85C) and humidity (0-80%) sensors. They're super simple to use over the common and friendly I2C bus.

{{% readfile "/_common/_footer/_footer-cart.md" %}}

## Connections

![](/images/docs/demo/si7021-sch.png) ![](/images/docs/demo/si7021-pin.png)

|Bus Pirate|SHT21|Description|
|-|-|-|
|SDA|SDA|I2C Data|
|SCL|SCL|I2C Clock|
|Vout/Vref|VDD|3.3volt power supply|
|GND|GND|Ground|

## Setup

{{< termfile source="static/snippets/si7021-setup.html" >}}

SI7021 is an I2C device, so we need to set the Bus Pirate to I2C mode.

- ```m i2c``` - set the Bus Pirate to I2C [mode]({{< relref "/docs/command-reference/#m-set-bus-mode" >}}), or just hit ```m``` to select from the menu.
- ```400``` - set the I2C bus speed to 400kHz.
- ```1``` - disable clock stretching.

{{% alert context="info" %}}
The SI7021 supports clock stretching, which is a way for the device to signal that it needs more time to process a command. It adds some complexity though, so we've disabled it for this demo.
{{% /alert %}}

### Power supply
![](/images/docs/demo/si7021-datasheet-power.png)

According to the datasheet, the SI7021 requires a 1.9-3.6 volt power supply. 

Image source: [datasheet](https://sensirion.com/media/documents/120BBE4C/63500094/Sensirion_Datasheet_Humidity_Sensor_SHT21.pdf).

{{< termfile source="static/snippets/si7021-power.html" >}}

Letâ€™s set the Bus Pirate to power the chip at 3.3volts, a very common voltage for modern I2C devices.
- ```W 3.3``` - enable the [onboard power supply]({{< relref "/docs/command-reference/#ww-power-supply-offon">}}) at 3.3volts.

### Pull-up resistors

{{< termfile source="static/snippets/si7021-pullup.html" >}}

I2C is an open collector output bus, the Bus Pirate and the SI7021 can only pull the line low to 0 (ground). A pull-up resistor is needed to pull the line high to 1 (3.3 volts). The Bus Pirate has built-in pull-up resistors that can be enabled with the ```P``` command.
- ```P``` - Enable the [onboard pull-up resistors]({{< relref "/docs/command-reference/#pp-pull-up-resistors">}}).

{{% alert context="warning" %}} 
Be sure to enable the pull-up resistors. The data line will never go high without them and you'll read only 0s.
{{% /alert %}}

## I2C address scan

{{< termfile source="static/snippets/si7021-scan.html" >}}

We need the correct I2C address to talk to the sensor. We could look in the datasheet, or we can run the handy [I2C address scanner]({{< relref "/docs/command-reference/#scan-i2c-address-search">}}).
- ```scan``` - Scan the I2C bus for devices

The scanner found an I2C device at address 0x40 (0x80 write, 0x81 read).

{{% alert context="info" %}} 
If the scanner doesn't find the device, ensure the power supply is enabled ```W 5``` and the pull-up resistors are enabled ```P```. Also check that slide switches SW1 and SW2 select VOUT and GND respectively.
{{% /alert %}}

## Commands

![](/images/docs/demo/si7021-datasheet-commands.png)

The SI7021 has a number of commands that can be sent over I2C. In this demo we'll use the following commands:
- ```0xf5``` - Measure humidity, no hold master
- ```0xf3``` - Measure temperature, no hold master
- ```0xe7``` - Read user register 1
- ```0x84 0xb8``` - Read firmware version

## Check configuration

![](/images/docs/demo/si7021-datasheet-sense-time.png)

Accurate temperature and humidity measurements take longer than low resolution measurements. The table shows that an 8-bit humidity measurement completes in 3.1ms, while a 12-bit resolution measurement takes four times longer (12ms).

If you want the highest resolution and you have the time to spare, SI7021 can do that! In a hurry and don't need the absolute best accuracy? SI7021 can do that too! 
 
{{< termfile source="static/snippets/si7021-read-config.html" >}}

SI7021 should default to 12-bit humidity and 14-bit temperature measurement after power up. Let's check the configuration to be sure. The current settings are stored in **User Register 1**.

- ```[``` - I2C START bit
- ```0x80``` - SI7021 write address
- ```0xe7``` - Read user register command
- ```[``` - I2C repeated START bit
- ```0x81``` - SI7021 read address
- ```r:1``` - Read one byte
- ```]``` - I2C STOP bit 

User register 1 returns 0x3A.

![](/images/docs/demo/si7021-datasheet-userreg.png)

Bit 7 and bit 0 of the user register set the measurement resolution. Bit 6 shows the power status. There's some other stuff in there too, but this is enough to get a flavor. 

{{< termfile source="static/snippets/si7021-config-convert.html" >}} 

Let's convert the register value to binary so it's a bit easier to read.

## Measure humidity

{{< term "Bus Pirate [/dev/ttyS0]" >}}
<span style="color:#96cb59">I2C></span> [0x80 0xf5] D:23 [0x81 r:2]

I2C START
<span style="color:#bfa530">TX:</span> 0x<span style="color:#53a6e6">80</span> ACK 0x<span style="color:#53a6e6">F5</span> ACK 
I2C STOP
<span style="color:#bfa530">Delay:</span> <span style="color:#53a6e6">23</span>ms
I2C START
<span style="color:#bfa530">TX:</span> 0x<span style="color:#53a6e6">81</span> ACK 
<span style="color:#bfa530">RX:</span> 0x<span style="color:#53a6e6">AA</span> ACK 0x<span style="color:#53a6e6">02</span> NACK 
I2C STOP
{{< /term >}}

### Start a measurement

- The SI7021 I2C address is 0x80 (write) and 0x81 (read).
- Command 0xf5 triggers a humidity and temperature measurement
- The full I2C command begins with I2C START ```[```, the device write address ```0x80```, the begin measurement command ```0xf5``` and ends with I2C STOP ```]``` 

### Delay

- It takes up to 23ms to complete a humidity and temperature measurement. 
- The SI7021 will not acknowledge its read or write address while the measurement is in progress. In software we can use this feature to repeatedly poll the device until the measurement is complete.
- For this demo we'll just delay for 23ms ```D:23``` before attempting to read.

### Read measurement

- After a 23ms delay a measurement is ready to read. 
- Send an I2C START ```[```, the device read address ```0x81```, read two bytes ```r:2```, end with an I2C Stop ```]```.
- Our sensor returned 0xaa 0x02.

### Convert to humidity

{{< term "Bus Pirate [/dev/ttyS0]" >}}
<span style="color:#96cb59">I2C></span> = 0xaa02
 =0x<span style="color:#53a6e6">AA</span>02.16 =43522.16 =0b<span style="color:#53a6e6">1010</span>1010<span style="color:#53a6e6">0000</span>0010.16
<span style="color:#96cb59">I2C></span> 
{{< /term >}}

- The two bytes can now be converted into a humidity measurement. 
- Use the ```=``` convert number format command to find the decimal equivalent of 0xaa02 for easier calculation (43522).

> %RH= ((125 \* value)/65536)-6  
 %RH= ((125 \* 43522)/65536)-6  
 %RH= 77.01%

- Percent humidity is calculated using the formula above.

## Measure temperature

{{< term "Bus Pirate [/dev/ttyS0]" >}}
<span style="color:#96cb59">I2C></span> [0x80 0xf3] D:100 [0x81 r:2]

I2C START
<span style="color:#bfa530">TX:</span> 0x<span style="color:#53a6e6">80</span> ACK 0x<span style="color:#53a6e6">F3</span> ACK 
I2C STOP
<span style="color:#bfa530">Delay:</span> <span style="color:#53a6e6">100</span>ms
I2C START
<span style="color:#bfa530">TX:</span> 0x<span style="color:#53a6e6">81</span> ACK 
<span style="color:#bfa530">RX:</span> 0x<span style="color:#53a6e6">5E</span> ACK 0x<span style="color:#53a6e6">D4</span> NACK 
I2C STOP
{{< /term >}}

- Use the 0xf3 command to measure temperature, similar to measuring humidity
- Send command ```0xf3``` to the write address: ```[0x80 0xf3]```
- Delay according to the datasheet, but I used 100ms to be safe ```D:100``` 
- Now grab two bytes from the read address: ```[0x81 r:2]```
- The temperature value is 0x53 0xd4.

### Convert to temperature

{{< term "Bus Pirate [/dev/ttyS0]" >}}
<span style="color:#96cb59">I2C></span> = 0x5ed4
 =0x<span style="color:#53a6e6">5E</span>D4.16 =24276.16 =0b<span style="color:#53a6e6">0101</span>1110<span style="color:#53a6e6">1101</span>0100.16
<span style="color:#96cb59">I2C></span> 
{{< /term >}}

- Use the ```=``` convert number format command to find the decimal equivalent of 0x5ed4 for easier calculation (24276).

> Temp C = ((175.72 \* value)/65536)-46.85  
Temp C = ((175.72 \* 24276)/65536)-46.85  
Temp C = 18.24 C

- Temperature is calculated using the formula above.

## Read serial number

{{< term "Bus Pirate [/dev/ttyS0]" >}}
<span style="color:#96cb59">I2C></span> 
<span style="color:#96cb59">I2C></span> [0x80 0xfa 0xf0] [0x81 r:8]

I2C START
<span style="color:#bfa530">TX:</span> 0x<span style="color:#53a6e6">80</span> ACK 0x<span style="color:#53a6e6">FA</span> ACK 0x<span style="color:#53a6e6">F0</span> ACK 
I2C STOP
I2C START
<span style="color:#bfa530">TX:</span> 0x<span style="color:#53a6e6">81</span> ACK 
<span style="color:#bfa530">RX:</span> 0x90 ACK 0x39 ACK 0x3C ACK 0xB8 ACK 0xA6 ACK 0x5A ACK 0xCC ACK 0x3A NACK  
I2C STOP
{{< /term >}}

- Each chip has a unique 8 byte serial number. The serial number is mixed in with CRC error checking bytes, some assembly is required
- Write command ```0xfa 0xf0``` to retrieve eight bytes: ```[0x80 0xfa 0xf0] [0x81 r:8]```
- Byte 1, 3, 5 and 6 (0x903ca6cc) the **middle** four bytes of the serial number
- The other values are CRC error checking values that we'll ignore

{{< term "Bus Pirate [/dev/ttyS0]" >}}

<span style="color:#96cb59">I2C></span> [0x80 0xfc 0xc9] [0x81 r:6]

I2C START
<span style="color:#bfa530">TX:</span> 0x<span style="color:#53a6e6">80</span> ACK 0x<span style="color:#53a6e6">FC</span> ACK 0x<span style="color:#53a6e6">C9</span> ACK 
I2C STOP
I2C START
<span style="color:#bfa530">TX:</span> 0x<span style="color:#53a6e6">81</span> ACK 
<span style="color:#bfa530">RX:</span> 0x01 ACK 0x42 ACK 0xAB ACK 0x00 ACK 0x80 ACK 0x7A NACK 
I2C STOP
<span style="color:#96cb59">I2C></span>
{{< /term >}}

- Write command ```0xfc 0xc9``` and read 6 bytes: ```[0x80 0xfc 0xc9] [0x81 r:6]```
- The first and second byte (0x0142) are the **last** two bytes of the serial number
- The fourth and fifth byte (0x0080) are the **first** two bytes of the serial number
- The complete serial number of this chip is 0x0080903ca6cc0142.

## Read firmware version

{{< term "Bus Pirate [/dev/ttyS0]" >}}
<span style="color:#96cb59">I2C></span> [0x80 0x84 0xb8] [0x81 r]

I2C START
<span style="color:#bfa530">TX:</span> 0x<span style="color:#53a6e6">80</span> ACK 0x<span style="color:#53a6e6">84</span> ACK 0x<span style="color:#53a6e6">B8</span> ACK 
I2C STOP
I2C START
<span style="color:#bfa530">TX:</span> 0x<span style="color:#53a6e6">81</span> ACK 
<span style="color:#bfa530">RX:</span> 0x<span style="color:#53a6e6">20</span> NACK 
I2C STOP
<span style="color:#96cb59">I2C></span>
{{< /term >}}

{{% alert context="danger" %}}
This command is only supported by the SI7021
{{% /alert %}}


- A single byte indicates the sensor firmware version
- Write command ```0x84 0xb8``` and then read one byte: ```[0x80 0x84 0xb8] [0x81 r]```

|Value|Version|
|-|-|
|0xFF|1.0|
|0x20|2.0|

- This chip has firmware version 2.0

## Macro

{{< term "Bus Pirate [/dev/ttyS0]" >}}
<span style="color:#96cb59">I2C></span> (2)
SI7021/HTU21/SHT21/HDC1080 Temp & Humidity sensor
Humidity:
 [0x80 0xf5] D:23 [0x81 r:2]
 70.14% (0x9b 0xee)
Temperature:
 [0x80 0xf3] D:100 [0x81 r:2]
 19.77C (0x61 0x10)
Serial Number:
 [0x80 0xfa 0xf0] [0x81 r:8] [0x80 0xfc 0xc9] [0x81 r:6]
0x0080903ca6cc0142
<span style="color:#96cb59">I2C></span> 
{{< /term >}}

Macro ```(2)``` in I2C mode automates the commands on this page. 

## Get a Bus Pirate


{{% readfile "/_common/_footer/_footer-get.md" %}}

### Community


{{% readfile "/_common/_footer/_footer-community.md" %}}